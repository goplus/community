<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Go+ Community - Edit Profile</title>
    <link rel="icon" href="static/img/favicon.svg">
</head>

<body>
    {{ template "header" .}}

    <div id="app" class="h-full w-full" style="padding: 0 30px;">
        <n-breadcrumb>
            <n-breadcrumb-item href="/">
                <div class="flex items-center">
                    <div>
                        <span></span>
                        <i class="ph-duotone ph-house" style="font-size: 18px; margin-right: 5px;"></i>
                    </div>
                    Home
                </div>
            </n-breadcrumb-item>
            <n-breadcrumb-item :href="'/user/'+user.Id">
                <div class="flex items-center">
                    <div>
                        <span></span>
                        <i class="ph-duotone ph-user" style="font-size: 18px; margin-right: 5px;"></i>
                    </div>
                    ${ userProfile.displayName }
                </div>
            </n-breadcrumb-item>
            <n-breadcrumb-item>
                <div class="flex items-center">
                    <div>
                        <span></span>
                        <i class="ph-duotone ph-pencil-line" style="font-size: 18px; margin-right: 5px;"></i>
                    </div>
                    <span style="font-weight: 600;">Edit Profile</span>
                </div>
            </n-breadcrumb-item>
        </n-breadcrumb>

        <n-tabs default-value="profile" animated type="card" placement="left" size="large" 
        :theme-overrides="tabsTheme" style="margin-top: 20px;">
            <!-- Profile -->
            <n-tab-pane name="profile" style="height: 80vh;">
                <template #tab>
                    <i class="ph-duotone ph-identification-card" style="font-size: 22px; margin-right: 12px;"></i>
                    Profile
                </template>

                <div class="w-full flex items-center justify-between">
                    <div class="px-6 py-2 text-medium text-gray-500 w-full">
                        <h3 class="text-2xl font-bold text-gray-900 mb-1">User Profile</h3>
                        <p class="mb-2">Complete your profile for display on your personal homepage.</p>
                    </div>
                    <n-button @click="editProfile" color="#3182ce" :loading="!canSubmit" :disabled="!canSubmit"
                        style="--n-border-radius: 7px; background-color: #3182ce;">
                        <!-- :theme-overrides="buttonThemeOverrides -->
                        <template #icon>
                            <i class="ph ph-floppy-disk"></i>
                        </template>
                        <span style="font-weight: 600;">Save changes</span>
                    </n-button>
                </div>

                <div class="bg-white rounded-lg w-full flex" style="padding: 20px 30px;">
                    <n-form :model="userProfile" inline ref="formRef" :rules="rules">
                        <n-form-item path="avatar" show-require-mark require-mark-placement="right-hanging"
                            style="width: 10%;">
                            <template #label>
                                <p class="font-semibold text-gray-900 truncate">Avatar</p>
                            </template>
                            <n-upload :max="1" directory-dnd accept="image/png, image/jpg, image/jpeg"
                                @change="changeCover" :custom-request="customRequest" list-type="image-card"
                                :default-file-list="fileList" style="width: 80%; height: 80%;">
                                <n-upload-dragger></n-upload-dragger>
                            </n-upload>
                        </n-form-item>

                        <n-grid :cols="2" :x-gap="20" style="width: 60%; margin-left: 40px;">
                            <!-- Name -->
                            <n-form-item-gi :span="2" path="displayName" show-require-mark
                                require-mark-placement="right-hanging">
                                <template #label>
                                    <p class="font-semibold text-gray-900 truncate">Nick Name</p>
                                </template>
                                <n-input v-model:value="userProfile.displayName" placeholder="Input Nick Name" 
                                :theme-overrides="inputTheme"
                                :rule="{
                                        required: true,
                                        message: 'Please input your nick name',
                                        trigger: ['input', 'blur']
                                    }">
                                </n-input>
                            </n-form-item-gi>

                            <!-- Gender -->
                            <n-form-item-gi :span="1" path="gender">
                                <template #label>
                                    <p class="font-semibold text-gray-900 truncate">Gender</p>
                                </template>
                                <n-select v-model:value="userProfile.gender" placeholder="Select Gender"
                                :options="genderOptions" :theme-overrides="selectTheme">
                                </n-select>
                            </n-form-item-gi>

                            <!-- Birthday -->
                            <n-form-item-gi :span="1" path="birthday">
                                <template #label>
                                    <p class="font-semibold text-gray-900 truncate">Birthday</p>
                                </template>
                                <n-date-picker v-model:formatted-value="userProfile.birthday"
                                    type="date" :theme-overrides="datePickerTheme">
                                </n-date-picker>
                            </n-form-item-gi>

                            <!-- Email -->
                            <n-form-item-gi :span="2" path="email">
                                <template #label>
                                    <p class="font-semibold text-gray-900 truncate">Email</p>
                                </template>
                                <n-input v-model:value="userProfile.email" placeholder="Input Email"
                                :theme-overrides="inputTheme"
                                :rule="{
                                        required: true,
                                        message: 'Please input your email',
                                        trigger: ['input', 'blur']
                                    }">
                                </n-input>
                            </n-form-item-gi>

                            <!-- Phone -->
                            <n-form-item-gi :span="2" path="phone">
                                <template #label>
                                    <p class="font-semibold text-gray-900 truncate">Phone Number</p>
                                </template>
                                <n-input v-model:value="userProfile.phone" placeholder="Input Phone Number"
                                    :allow-input="onlyAllowNumber"
                                    :theme-overrides="inputTheme"
                                    :rule="{
                                        required: true,
                                        message: 'Please input your phone number',
                                        trigger: ['input', 'blur']
                                    }">
                                </n-input>
                            </n-form-item-gi>
                        </n-grid>
                    </n-form>
                </div>
            </n-tab-pane>

            <!-- Account -->
            <n-tab-pane name="account" style="height: 80vh;">
                <template #tab>
                    <i class="ph-duotone ph-users" style="font-size: 22px; margin-right: 12px;"></i>
                    Account
                </template>

                <div class="px-6 py-2 text-medium text-gray-500 w-full">
                    <h3 class="text-2xl font-bold text-gray-900 mb-1">Bind accounts</h3>
                    <p class="mb-2">Bind with your mainstream platform account to make login easier.</p>
                </div>

                <div class="bg-white rounded-lg w-full" style="padding: 10px 30px;">
                    <ul class="divide-y divide-gray-200 w-full">
                        <li class="px-4 py-3 w-full flex items-center justify-between"
                            v-for="accountItem in accountList">
                            <div class="flex items-center">
                                <img class="w-8 h-8 rounded-full" :src="accountItem.img" alt="Platform Logo" />
                                <div style="margin-left: 30px;">
                                    <p class="font-semibold text-gray-900 truncate">
                                        ${ accountItem.platform }
                                    </p>
                                    <p class="text-sm text-gray-500 truncate">
                                        ${ accountItem.desc }
                                    </p>
                                </div>
                            </div>

                            <div class="text-base font-semibold text-gray-900">
                                <!-- Bind Button -->
                                <n-button v-if="!accountItem.bind" @click="openBindPage(accountItem.url)" :theme-overrides="buttonTheme">
                                    <template #icon>
                                        <i class="ph-bold ph-lock-key"></i>
                                    </template>
                                    <span style="font-weight: 600;">Bind</span>
                                </n-button>

                                <!-- Unbind Button -->
                                <n-button v-else @click="openUnbindPage(accountItem.platform)" color="#3182ce"
                                    style="--n-border-radius: 7px; background-color: #3182ce;">
                                    <template #icon>
                                        <i class="ph ph-lock-key-open"></i>
                                    </template>
                                    <span style="font-weight: 600;">Unbind</span>
                                </n-button>
                            </div>
                        </li>
                    </ul>
                </div>
            </n-tab-pane>
        </n-tabs>
        <n-modal v-model:show="wechatModel.show">
            <img :src="wechatModel.data"/>
          </n-modal>
    </div>

    <script>
        const { reactive, toRefs, ref, h } = Vue;
        
        const userProfile = ref({{.CurrentUser}}) 
        const application = {{.Application}}
        const accountBinds = {{.Binds}}
        const user = {{.User}}
        const wechatModel = ref({
            show: false,
            data: "",
            ticket: "",
        })

        /*======= user =======*/
        if (userProfile.value.birthday === "" || userProfile.value.birthday === "undefined"){
            userProfile.value.birthday = undefined
        }
        const genderOptions = [
            {
                label: "Male",
                value: "male"
            },
            {
                label: "Female",
                value: "female"
            }
        ]
        const fileList = ref([{
            id: "avatar",
            status: "finished",
            url: userProfile.value.avatar,
        }])
        const formRef = ref(null);
        const rules = {
            email: [
                {
                    validator(rule, value) {
                        if (value === ""){
                            return true
                        }
                        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
                            return new Error("please input a vaild email");
                        } 
                        return true;
                    },
                    trigger: ["input", "blur"]
                }
            ],
            phone: [
                {
                    validator(rule, value) {
                        if (value === ""){
                            return true
                        }
                        if (!/^[1][3-9][0-9]{9}$/.test(value)) {
                            return new Error("please input a vaild phone");
                        } 
                        return true;
                    },
                    trigger: ["input", "blur"]
                }
            ],
        }
        let avatarUrl = userProfile.value.avatar

        const canSubmit  = ref(true)
        function customRequest(option) {
            canSubmit.value = false
            const file = option.file
            const avatarData = new FormData();
            avatarData.append('file', file.file);

            const options = {
                method: 'POST',
                body: avatarData,
            }
            fetch("/api/media", options)
                .then(res => {
                    return res.json();
                })
                .then(todos => {
                    fetch('/api/media/'+todos+'/url')
                        .then(resUrl => {
                            return resUrl.json();
                        })
                        .then(todosUrl => {
                            if (todosUrl.code === 200) {
                                avatarUrl = todosUrl.url
                            }
                            canSubmit.value = true
                        });

                });
        }

        function onlyAllowNumber(value) {
            return !value || /^\d+$/.test(value);
        }

        function objectToFormData(obj) {
            const formData = new FormData();

            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                formData.append(key, obj[key]);
                }
            }

            return formData;
        }

        function editProfile() {
            this.$refs.formRef?.validate((errors) => {
                if (!errors) {
                    userProfile.value.avatar = avatarUrl
                    const formData = objectToFormData(userProfile.value);

                    const requestOptions = {
                        method: "PUT",
                        body: formData
                    };

                    fetch("/api/user", requestOptions)
                        .then(res => {
                            return res.json();
                        })
                        .then(todos => {
                            if (todos.code === 200) {
                                window.location.href = "/user/" + userProfile.value.id
                            }
                        });
                }
            })
        }

        /*======= account =======*/

        const casdoorUrl = {{.casdoorUrl}}
        const authInfo = {
            Google: {
                scope: "profile+email",
                endpoint: "https://accounts.google.com/signin/oauth",
            },
            GitHub: {
                scope: "user:email+read:user",
                endpoint: "https://github.com/login/oauth/authorize",
            },
            QQ: {
                scope: "get_user_info",
                endpoint: "https://graph.qq.com/oauth2.0/authorize",
            },
            WeChat: {
                scope: "snsapi_login",
                endpoint: "https://open.weixin.qq.com/connect/qrconnect",
                mpScope: "snsapi_userinfo",
                mpEndpoint: "https://open.weixin.qq.com/connect/oauth2/authorize",
            },
            WeChatMiniProgram: {
                endpoint: "https://mp.weixin.qq.com/",
            },
            Facebook: {
                scope: "email,public_profile",
                endpoint: "https://www.facebook.com/dialog/oauth",
            },
            DingTalk: {
                scope: "openid",
                endpoint: "https://login.dingtalk.com/oauth2/auth",
            },
            Weibo: {
                scope: "email",
                endpoint: "https://api.weibo.com/oauth2/authorize",
            },
            Gitee: {
                scope: "user_info%20emails",
                endpoint: "https://gitee.com/oauth/authorize",
            },
            LinkedIn: {
                scope: "r_liteprofile%20r_emailaddress",
                endpoint: "https://www.linkedin.com/oauth/v2/authorization",
            },
            WeCom: {
                scope: "snsapi_userinfo",
                endpoint: "https://open.work.weixin.qq.com/wwopen/sso/3rd_qrConnect",
                silentEndpoint: "https://open.weixin.qq.com/connect/oauth2/authorize",
                internalEndpoint: "https://open.work.weixin.qq.com/wwopen/sso/qrConnect",
            },
            Lark: {
                // scope: "email",
                endpoint: "https://open.feishu.cn/open-apis/authen/v1/index",
            },
            GitLab: {
                scope: "read_user+profile",
                endpoint: "https://gitlab.com/oauth/authorize",
            },
            ADFS: {
                scope: "openid",
                endpoint: "http://example.com",
            },
            Baidu: {
                scope: "basic",
                endpoint: "http://openapi.baidu.com/oauth/2.0/authorize",
            },
            Alipay: {
                scope: "basic",
                endpoint: "https://openauth.alipay.com/oauth2/publicAppAuthorize.htm",
            },
            Casdoor: {
                scope: "openid%20profile%20email",
                endpoint: "http://example.com",
            },
            Infoflow: {
                endpoint: "https://xpc.im.baidu.com/oauth2/authorize",
            },
            Apple: {
                scope: "name%20email",
                endpoint: "https://appleid.apple.com/auth/authorize",
            },
            AzureAD: {
                scope: "user.read",
                endpoint: "https://login.microsoftonline.com/common/oauth2/v2.0/authorize",
            },
            AzureADB2C: {
                scope: "openid",
                endpoint: "https://tenant.b2clogin.com/tenant.onmicrosoft.com/userflow/oauth2/v2.0/authorize",
            },
            Slack: {
                scope: "users:read",
                endpoint: "https://slack.com/oauth/authorize",
            },
            Steam: {
                endpoint: "https://steamcommunity.com/openid/login",
            },
            Okta: {
                scope: "openid%20profile%20email",
                endpoint: "http://example.com",
            },
            Douyin: {
                scope: "user_info",
                endpoint: "https://open.douyin.com/platform/oauth/connect",
            },
            Custom: {
                endpoint: "https://example.com/",
            },
            Bilibili: {
                endpoint: "https://passport.bilibili.com/register/pc_oauth2.html",
            },
            Line: {
                scope: "profile%20openid%20email",
                endpoint: "https://access.line.me/oauth2/v2.1/authorize",
            },
            Amazon: {
                scope: "profile",
                endpoint: "https://www.amazon.com/ap/oa",
            },
            Auth0: {
                scope: "openid%20profile%20email",
                endpoint: "http://auth0.com/authorize",
            },
            BattleNet: {
                scope: "openid",
                endpoint: "https://oauth.battlenet.com.cn/authorize",
            },
            Bitbucket: {
                scope: "account",
                endpoint: "https://bitbucket.org/site/oauth2/authorize",
            },
            Box: {
                scope: "root_readwrite",
                endpoint: "https://account.box.com/api/oauth2/authorize",
            },
            CloudFoundry: {
                scope: "cloud_controller.read",
                endpoint: "https://login.cloudfoundry.org/oauth/authorize",
            },
            Dailymotion: {
                scope: "userinfo",
                endpoint: "https://api.dailymotion.com/oauth/authorize",
            },
            Deezer: {
                scope: "basic_access",
                endpoint: "https://connect.deezer.com/oauth/auth.php",
            },
            DigitalOcean: {
                scope: "read",
                endpoint: "https://cloud.digitalocean.com/v1/oauth/authorize",
            },
            Discord: {
                scope: "identify%20email",
                endpoint: "https://discord.com/api/oauth2/authorize",
            },
            Dropbox: {
                scope: "account_info.read",
                endpoint: "https://www.dropbox.com/oauth2/authorize",
            },
            EveOnline: {
                scope: "publicData",
                endpoint: "https://login.eveonline.com/oauth/authorize",
            },
            Fitbit: {
                scope: "activity%20heartrate%20location%20nutrition%20profile%20settings%20sleep%20social%20weight",
                endpoint: "https://www.fitbit.com/oauth2/authorize",
            },
            Gitea: {
                scope: "user:email",
                endpoint: "https://gitea.com/login/oauth/authorize",
            },
            Heroku: {
                scope: "global",
                endpoint: "https://id.heroku.com/oauth/authorize",
            },
            InfluxCloud: {
                scope: "read:org",
                endpoint: "https://cloud2.influxdata.com/oauth/authorize",
            },
            Instagram: {
                scope: "user_profile",
                endpoint: "https://api.instagram.com/oauth/authorize",
            },
            Intercom: {
                scope: "user.read",
                endpoint: "https://app.intercom.com/oauth",
            },
            Kakao: {
                scope: "account_email",
                endpoint: "https://kauth.kakao.com/oauth/authorize",
            },
            Lastfm: {
                scope: "user_read",
                endpoint: "https://www.last.fm/api/auth",
            },
            Mailru: {
                scope: "userinfo",
                endpoint: "https://oauth.mail.ru/login",
            },
            Meetup: {
                scope: "basic",
                endpoint: "https://secure.meetup.com/oauth2/authorize",
            },
            MicrosoftOnline: {
                scope: "openid%20profile%20email",
                endpoint: "https://login.microsoftonline.com/common/oauth2/v2.0/authorize",
            },
            Naver: {
                scope: "profile",
                endpoint: "https://nid.naver.com/oauth2.0/authorize",
            },
            Nextcloud: {
                scope: "openid%20profile%20email",
                endpoint: "https://cloud.example.org/apps/oauth2/authorize",
            },
            OneDrive: {
                scope: "offline_access%20onedrive.readonly",
                endpoint: "https://login.live.com/oauth20_authorize.srf",
            },
            Oura: {
                scope: "personal",
                endpoint: "https://cloud.ouraring.com/oauth/authorize",
            },
            Patreon: {
                scope: "identity",
                endpoint: "https://www.patreon.com/oauth2/authorize",
            },
            PayPal: {
                scope: "openid%20profile%20email",
                endpoint: "https://www.sandbox.paypal.com/connect",
            },
            SalesForce: {
                scope: "openid%20profile%20email",
                endpoint: "https://login.salesforce.com/services/oauth2/authorize",
            },
            Shopify: {
                scope: "read_products",
                endpoint: "https://myshopify.com/admin/oauth/authorize",
            },
            Soundcloud: {
                scope: "non-expiring",
                endpoint: "https://api.soundcloud.com/connect",
            },
            Spotify: {
                scope: "user-read-email",
                endpoint: "https://accounts.spotify.com/authorize",
            },
            Strava: {
                scope: "read",
                endpoint: "https://www.strava.com/oauth/authorize",
            },
            Stripe: {
                scope: "read_only",
                endpoint: "https://connect.stripe.com/oauth/authorize",
            },
            TikTok: {
                scope: "user.info.basic",
                endpoint: "https://www.tiktok.com/auth/authorize/",
            },
            Tumblr: {
                scope: "email",
                endpoint: "https://www.tumblr.com/oauth2/authorize",
            },
            Twitch: {
                scope: "user_read",
                endpoint: "https://id.twitch.tv/oauth2/authorize",
            },
            Twitter: {
                scope: "users.read%20tweet.read",
                endpoint: "https://twitter.com/i/oauth2/authorize",
            },
            Typetalk: {
                scope: "my",
                endpoint: "https://typetalk.com/oauth2/authorize",
            },
            Uber: {
                scope: "profile",
                endpoint: "https://login.uber.com/oauth/v2/authorize",
            },
            VK: {
                scope: "email",
                endpoint: "https://oauth.vk.com/authorize",
            },
            Wepay: {
                scope: "manage_accounts%20view_user",
                endpoint: "https://www.wepay.com/v2/oauth2/authorize",
            },
            Xero: {
                scope: "openid%20profile%20email",
                endpoint: "https://login.xero.com/identity/connect/authorize",
            },
            Yahoo: {
                scope: "openid%20profile%20email",
                endpoint: "https://api.login.yahoo.com/oauth2/request_auth",
            },
            Yammer: {
                scope: "user",
                endpoint: "https://www.yammer.com/oauth2/authorize",
            },
            Yandex: {
                scope: "login:email",
                endpoint: "https://oauth.yandex.com/authorize",
            },
            Zoom: {
                scope: "user:read",
                endpoint: "https://zoom.us/oauth/authorize",
            },
            MetaMask: {
                scope: "",
                endpoint: "",
            },
            Web3Onboard: {
                scope: "",
                endpoint: "",
            },
        };

        const providers = {{.providers}}

        function getStateFromQueryParams(applicationName, providerName, method, isShortState) {
            let query = window.location.search;
            query = `${query}&application=${encodeURIComponent(applicationName)}&provider=${encodeURIComponent(providerName)}&method=${method}`;
            if (method === "link") {
                query = `${query}&from=${window.location.href}`;
            }

            if (!isShortState) {
                return btoa(query);
            } else {
                const state = providerName;
                sessionStorage.setItem(state, query);
                return state;
            }
        }

        function getAuthUrl(provider, method, code) {
            if (provider === null || !provider.type) {
                return "";
            }   
            let endpoint = authInfo[provider.type].endpoint;
            let redirectUri = `${casdoorUrl}/callback`;
            const scope = authInfo[provider.type].scope;

            // rm (provider.type === "Twitter")
            const isShortState = (provider.type === "WeChat" && navigator.userAgent.includes("MicroMessenger"));
            const state = getStateFromQueryParams(application.name, provider.name, method, isShortState);
            const codeChallenge = "P3S-a7dr8bgM4bF6vOyiKkKETDl16rcAzao9F8UIL1Y"; // SHA256(Base64-URL-encode("casdoor-verifier"))

            if (provider.type === "AzureAD") {
                if (provider.domain !== "") {
                    endpoint = endpoint.replace("common", provider.domain);
                }
            } else if (provider.type === "Apple") {
                redirectUri = `${casdoorUrl}/api/callback`;
            }

            if (provider.type === "Google" || provider.type === "GitHub" || provider.type === "QQ" || provider.type === "Facebook"
                || provider.type === "Weibo" || provider.type === "Gitee" || provider.type === "LinkedIn" || provider.type === "GitLab" || provider.type === "AzureAD"
                || provider.type === "Slack" || provider.type === "Line" || provider.type === "Amazon" || provider.type === "Auth0" || provider.type === "BattleNet"
                || provider.type === "Bitbucket" || provider.type === "Box" || provider.type === "CloudFoundry" || provider.type === "Dailymotion"
                || provider.type === "DigitalOcean" || provider.type === "Discord" || provider.type === "Dropbox" || provider.type === "EveOnline" || provider.type === "Gitea"
                || provider.type === "Heroku" || provider.type === "InfluxCloud" || provider.type === "Instagram" || provider.type === "Intercom" || provider.type === "Kakao"
                || provider.type === "MailRu" || provider.type === "Meetup" || provider.type === "MicrosoftOnline" || provider.type === "Naver" || provider.type === "Nextcloud"
                || provider.type === "OneDrive" || provider.type === "Oura" || provider.type === "Patreon" || provider.type === "PayPal" || provider.type === "SalesForce"
                || provider.type === "SoundCloud" || provider.type === "Spotify" || provider.type === "Strava" || provider.type === "Stripe" || provider.type === "Tumblr"
                || provider.type === "Twitch" || provider.type === "Typetalk" || provider.type === "Uber" || provider.type === "VK" || provider.type === "Wepay"
                || provider.type === "Xero" || provider.type === "Yahoo" || provider.type === "Yammer" || provider.type === "Yandex" || provider.type === "Zoom") {
                return `${endpoint}?client_id=${provider.clientId}&redirect_uri=${redirectUri}&scope=${scope}&response_type=code&state=${state}`;
            } else if (provider.type === "AzureADB2C") {
                return `https://${provider.domain}.b2clogin.com/${provider.domain}.onmicrosoft.com/${provider.appId}/oauth2/v2.0/authorize?client_id=${provider.clientId}&nonce=defaultNonce&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${scope}&response_type=code&state=${state}&prompt=login`;
            } else if (provider.type === "DingTalk") {
                return `${endpoint}?client_id=${provider.clientId}&redirect_uri=${redirectUri}&scope=${scope}&response_type=code&prompt=consent&state=${state}`;
            } else if (provider.type === "WeChat") {
                if (navigator.userAgent.includes("MicroMessenger")) {
                    return `${authInfo[provider.type].mpEndpoint}?appid=${provider.clientId2}&redirect_uri=${redirectUri}&state=${state}&scope=${authInfo[provider.type].mpScope}&response_type=code#wechat_redirect`;
                } else {
                    if (provider.clientId2 && provider?.disableSsl && provider?.signName === "media") {
                        return `${casdoorUrl}/callback?state=${state}&code=${"wechat_oa:" + code}`;
                    }
                    return `${endpoint}?appid=${provider.clientId}&redirect_uri=${redirectUri}&scope=${scope}&response_type=code&state=${state}#wechat_redirect`;
                }
            } else if (provider.type === "WeCom") {
                if (provider.subType === "Internal") {
                    if (provider.method === "Silent") {
                        endpoint = authInfo[provider.type].silentEndpoint;
                        return `${endpoint}?appid=${provider.clientId}&redirect_uri=${redirectUri}&state=${state}&scope=${scope}&response_type=code#wechat_redirect`;
                    } else if (provider.method === "Normal") {
                        endpoint = authInfo[provider.type].internalEndpoint;
                        return `${endpoint}?appid=${provider.clientId}&agentid=${provider.appId}&redirect_uri=${redirectUri}&state=${state}&usertype=member`;
                    } else {
                        return `https://error:not-supported-provider-method:${provider.method}`;
                    }
                } else if (provider.subType === "Third-party") {
                    if (provider.method === "Silent") {
                        endpoint = authInfo[provider.type].silentEndpoint;
                        return `${endpoint}?appid=${provider.clientId}&redirect_uri=${redirectUri}&state=${state}&scope=${scope}&response_type=code#wechat_redirect`;
                    } else if (provider.method === "Normal") {
                        return `${endpoint}?appid=${provider.clientId}&redirect_uri=${redirectUri}&state=${state}&usertype=member`;
                    } else {
                        return `https://error:not-supported-provider-method:${provider.method}`;
                    }
                } else {
                    return `https://error:not-supported-provider-sub-type:${provider.subType}`;
                }
            } else if (provider.type === "Lark") {
                return `${endpoint}?app_id=${provider.clientId}&redirect_uri=${redirectUri}&state=${state}`;
            } else if (provider.type === "ADFS") {
                return `${provider.domain}/adfs/oauth2/authorize?client_id=${provider.clientId}&redirect_uri=${redirectUri}&state=${state}&response_type=code&nonce=casdoor&scope=openid`;
            } else if (provider.type === "Baidu") {
                return `${endpoint}?client_id=${provider.clientId}&redirect_uri=${redirectUri}&state=${state}&response_type=code&scope=${scope}&display=popup`;
            } else if (provider.type === "Alipay") {
                return `${endpoint}?app_id=${provider.clientId}&scope=auth_user&redirect_uri=${redirectUri}&state=${state}&response_type=code&scope=${scope}&display=popup`;
            } else if (provider.type === "Casdoor") {
                return `${provider.domain}/login/oauth/authorize?client_id=${provider.clientId}&redirect_uri=${redirectUri}&state=${state}&response_type=code&scope=${scope}`;
            } else if (provider.type === "Infoflow") {
                return `${endpoint}?appid=${provider.clientId}&redirect_uri=${redirectUri}?state=${state}`;
            } else if (provider.type === "Apple") {
                return `${endpoint}?client_id=${provider.clientId}&redirect_uri=${redirectUri}&state=${state}&response_type=code%20id_token&scope=${scope}&response_mode=form_post`;
            } else if (provider.type === "Steam") {
                return `${endpoint}?openid.claimed_id=http://specs.openid.net/auth/2.0/identifier_select&openid.identity=http://specs.openid.net/auth/2.0/identifier_select&openid.mode=checkid_setup&openid.ns=http://specs.openid.net/auth/2.0&openid.realm=${casdoorUrl}&openid.return_to=${redirectUri}?state=${state}`;
            } else if (provider.type === "Okta") {
                return `${provider.domain}/v1/authorize?client_id=${provider.clientId}&redirect_uri=${redirectUri}&state=${state}&response_type=code&scope=${scope}`;
            } else if (provider.type === "Douyin" || provider.type === "TikTok") {
                return `${endpoint}?client_key=${provider.clientId}&redirect_uri=${redirectUri}&state=${state}&response_type=code&scope=${scope}`;
            } else if (provider.type === "Custom") {
                return `${provider.customAuthUrl}?client_id=${provider.clientId}&redirect_uri=${redirectUri}&scope=${provider.scopes}&response_type=code&state=${state}`;
            } else if (provider.type === "Bilibili") {
                return `${endpoint}#/?client_id=${provider.clientId}&return_url=${redirectUri}&state=${state}&response_type=code`;
            } else if (provider.type === "Deezer") {
                return `${endpoint}?app_id=${provider.clientId}&redirect_uri=${redirectUri}&perms=${scope}`;
            } else if (provider.type === "Lastfm") {
                return `${endpoint}?api_key=${provider.clientId}&cb=${redirectUri}`;
            } else if (provider.type === "Shopify") {
                return `${endpoint}?client_id=${provider.clientId}&redirect_uri=${redirectUri}&scope=${scope}&state=${state}&grant_options[]=per-user`;
            } else if (provider.type === "Twitter" || provider.type === "Fitbit") {
                return `${endpoint}?client_id=${provider.clientId}&redirect_uri=${redirectUri}&state=${state}&response_type=code&scope=${scope}&code_challenge=${codeChallenge}&code_challenge_method=S256`;
            } else if (provider.type === "MetaMask") {
                return `${redirectUri}?state=${state}`;
            } else if (provider.type === "Web3Onboard") {
                return `${redirectUri}?state=${state}`;
            }
        }
        var _wechatHook = 0
        var wechatData = undefined
        const startWebhook = ()=>{
            if (_wechatHook) {
                clearInterval(_wechatHook)
            }
            _wechatHook = setInterval(()=> {
                fetch(`${casdoorUrl}/api/get-webhook-event?ticket=${wechatModel.value.ticket}`, {method: "GET"}).then(res=>{
                    return res.json()
                }).then(res=>{
                    if(res.status == "ok") {
                        wechatData = res.data2
                        clearInterval(_wechatHook)
                        window.location.href = getAuthUrl(findProvider("WeChat"), "link", wechatData)
                    }
                })
            }, 1000)
        }
        function openBindPage(url) {
            if(url == "WeChat") {
                fetch("/api/user/get-qrcode", {method: "GET"}).then(res=> {
                    return res.json();
                }).then(res=> {
                    if(res.code != 200) {
                        wechatModel.value = {
                            show: false,
                            data: "",
                            ticket: ""
                        }

                        return
                    }
                    startWebhook()
                    wechatModel.value = {
                        show: true,
                        data: `data:image/jpeg;base64,${res.data}`,
                        ticket: res.data2
                    }
                })
                return
            }
            window.location.href= (url);
        }

        function openUnbindPage(url) {
            const requestunlinkOptions = {
                        method: "GET"
                    };
            fetch("/api/user/acoount/unlink?pv=" + url, requestunlinkOptions).then(res => {
                            return res.json();
                        })
                        .then(todos => {
                            window.location.reload()
                        })
        }

        /*======= change theme =======*/
        const themeOverrides = {
            common: {
                primaryColor: '#3182ce',
                primaryColorHover: '#3d82d1',
                primaryColorPressed: '#3182ce',
            },
            Tab: {
                backgroundColor: '#3182ce',
            }
        }
        const buttonTheme = {
            borderRadiusMedium: '7px',
            rippleColor: '#7ba7d3',
            textColorHover: '#3182ce',
            textColorFocus: '#3182ce',
            textColorPressed: '#3d82d1',
            borderHover: '1px solid #3182ce',
            borderFocus: '1px solid #3182ce',
            borderPressed: '1px solid #3d82d1',
            colorInfo: '#3182ce',
            colorHoverInfo: '#7ba7d3',
            colorFocusInfo: '#3182ce',
            colorPressedInfo: '#3d82d1',
        }
        const inputTheme =  {
            caretColor: '#3182ce',
            borderHover: '1px solid #3182ce',
            borderFocus: '1px solid #3182ce',
            boxShadowFocus: '0 0 0 2px #cee1f5'
        }
        const selectTheme = {
            peers: {
                InternalSelection: {
                    caretColor: '#3182ce',
                    borderHover: '1px solid #3182ce',
                    borderFocus: '1px solid #3182ce',
                    borderActive: '1px solid #3182ce',
                    boxShadowFocus: '0 0 0 2px #cee1f5',
                    boxShadowActive: '0 0 0 2px #cee1f5'
                },
                
                InternalSelectMenu: {
                    optionTextColorPressed: '#3182ce',
                    optionTextColorActive: '#3182ce',
                    optionCheckColor: '#3182ce'
                },
            }
        }
        const datePickerTheme = {
            itemTextColorCurrent: '#3182ce',
            itemColorActive: '#3182ce',
            itemColorHover: '#cee1f5',
            peers: {
                Input: {
                    caretColor: '#3182ce',
                    borderHover: '1px solid #3182ce',
                    borderFocus: '1px solid #3182ce',
                    boxShadowFocus: '0 0 0 2px #cee1f5'
                },
                Button: {
                    rippleColor: '#7ba7d3',
                    textColorHover: '#3182ce',
                    textColorFocus: '#3182ce',
                    textColorPressed: '#3d82d1',
                    borderHover: '1px solid #3182ce',
                    borderFocus: '1px solid #3182ce',
                    borderPressed: '1px solid #3d82d1',
                }
            }
        }
        const tabsTheme = {
            tabFontWeightActive: '600',
            tabBorderRadius: '5px',
            tabTextColorHoverCard: '#3182ce',
            tabTextColorActiveCard: '#3182ce',
            tabColor: '#d5e5f6',
            tabBorderColor: '#cee1f5',
            tabGapMediumCard: '20px',
        }
        function findProvider(type) {
            let prov = providers.find(element => element.provider.type == type)
            if(prov) {
                return prov.provider
            }
            return undefined;
        }

        /*======= register vue component =======*/
        const app = Vue.createApp({
            data() {
                const accountList = []
                let temp = [
                        {
                            img: "/static/img/social_github.png",
                            platform: "GitHub",
                            desc: "https://github.com",
                            bind: accountBinds.Github,
                            provider: authInfo.GitHub,
                            url: ""
                        },
                        {
                            img: "/static/img/social_twitter.png",
                            platform: "Twitter",
                            desc: "https://twitter.com",
                            bind: accountBinds.Twitter,
                            provider: authInfo.Twitter,
                            url: ""
                        },
                        {
                            img: "/static/img/social_facebook.png",
                            platform: "Facebook",
                            desc: "https://facebook.com",
                            bind: accountBinds.Facebook,
                            provider: authInfo.Facebook,
                            url: ""
                        },
                        {
                            img: "/static/img/social_wechat.png",
                            platform: "WeChat",
                            desc: "https://weixin.qq.com",
                            bind: accountBinds.WeChat,
                            provider: authInfo.WeChat,
                            url: ""
                        }
                    ]
                    temp.forEach((e,i) => {
                        let provider = findProvider(e.platform)
                        if(!provider) {
                            return
                        }
                        if(e.platform === "WeChat") {
                            e.url = "WeChat"
                        }else {
                            e.url = getAuthUrl(provider, "link")
                        }
                        
                        accountList.push(e)
                    })
                return {
                    wechatModel,
                    buttonTheme,
                    inputTheme,
                    selectTheme,
                    datePickerTheme,
                    tabsTheme,
                    formRef,
                    rules,
                    canSubmit,
                    userProfile,
                    genderOptions,
                    fileList,
                    user,
                    accountList
                }
            },
            methods: {
                onlyAllowNumber,
                openBindPage,
                openUnbindPage,
                editProfile,
                customRequest,
            },
        });

        app.use(naive)
        app.config.compilerOptions.delimiters = ['${', '}']
        app.mount('#app')
    </script>
</body>

</html>

<style>
    .n-tabs .n-tabs-nav.n-tabs-nav--card-type .n-tabs-tab {
        border: 2px solid var(--n-tab-border-color);
    }

    .n-tabs .n-tabs-nav.n-tabs-nav--left.n-tabs-nav--card-type .n-tabs-pad {
        border-right: 1.5px solid var(--n-tab-border-color);
    }
</style>